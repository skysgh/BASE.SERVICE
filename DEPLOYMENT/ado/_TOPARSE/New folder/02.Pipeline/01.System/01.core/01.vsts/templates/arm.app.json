{
    // Using nested templates one can become more organised with templates and start re-using
    // common templates as library building blocks through different projects.
    // Refer to  reading Microsoftâ€™s best practice guidance on designing complex templates.
    // README:
    // Templates are a set of sequential parameters, variables, resources, output sections for a reason.
    // Parameters are the raw, unvalidated inputs -- whereas Variables are for staging, validating, 
    // cleaning up the raw inputs into variables safe enough to be used, within resources. 
    // 
    // Conventions:
    // * Resources should not reference parameters directly. It's quick and dirty to get 
    //   up and running and fine (sortof) for a poc, demo, tutorial, etc. But this is a library intended
    //   for reuse by different stakeholders, of varying ability -- and therefore
    //   held up to a higher standard of development. Use the damn variables!
    // * Parameters and Variables are named by convention to decrease inadvertent mistypings and 
    //   hours lost debugging (which is expontially harder
    //   in ARM due to the poor syntax accompanied by poor debugging tools.
    //   * Each parameter is spelled out in full with the prefix of the type. So even if its obvious (ie, 
    //     we're in an arm template called 'StorageAccount.json') the parameter's name 
    //     is 'microsoftStorageStorageAccountsResourceLocation' -- and not 'resourceLocation' or worse 'location'. 
    //     The rationale is that when you have a error message saying 'locaation' is not right, 
    //     and it's not even hinting as to which file it's annoyed wit...you have even a clue as 
    //     to where to start (eg: with 'location'...good luck. 
    //     You probably have 100 places to get yourself lost in.) 
    //
    // Tricks of the trade:
    // Comments are great...but they are not valid JSON. 
    // Luckily, Azure and VSTS now accept though... 
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    // README:
    // Parameters are to be considered raw/unvalidated/untrustable inputs.
    // * Parameter Types: can be 'int','bool','string','object','array'.
    // * Parameter Default Value: if null, will prompt and pause. Making it an empty string is a way to define
    //   that it's the default nothing...and then use [empty(...)]
    // * Parameter Allowed Values: prefer to use them, even if there is only one option to choose 
    //   from (improves validation, and understandablity of any valiation errors raised) 
    // * Location: ... is a difficult subject. 
    //   By convention, you want everything near each other (ie db closest to server, which is closest to use)
    //   But that's not always possible. For example. I might want all my servers in Australia....but 
    //   database servers can't be created there 
    //   (they're not offered). The closest accreditable 'nearshore' place I can find is 'southeastasia'.
    //   So we can't go off and blindly use '[resourceGroup().location]' (mirroring the 
    //   parent location, up to the resource group's location).
    //   It will work in most cases -- but not all:  
    //   * `resourceAltLocation`: ...hence the need for the `resourceAltLocation` parameter -- which 
    //     is used where needed. For example, when the sqlServerLocation is determined, it first looks to see if it 
    //     provided as a parameter. And if not, falls back to `resourceAltLocation`
    //   * And as for all child resources  (eg, sql firewall rules, database, etc.) they *have* to be match
    //     the same location as the parent (sql server) resource. So they don't get much of a
    //      say here -- we just reuse [variables('sql').server.resourceLocation] for them as well.
    //   * Choice: I'm not going to give much choice as to where you build resources. 
    //     These templates only allow Australia and southeastasia. Because
    //     I prefer to not be sorry about this later.
    //
    // Tips:
    // https://stackoverflow.com/questions/47834825/in-vs-code-disable-error-comments-are-not-permitted-in-json
    "parameters": {
        // -------------------------------------------------------
        // Parameters: ENVIRONMENT
        // -------------------------------------------------------
        "environmentId": {
            "metadata": {
                "description": "Required. The http based base url from which to download referenced linked Assembly ARM Templates. In most cases will be an Url to a Storage Account Container Url to which newly downloaded Source Files (just the ARM Templates) are copied to."
            },
            "type": "string"
        },

        // Optional. A hash, or environmentId to microsoftWebSitesHostNameBindingsHostName and microsoftWebSitesHostNameBindingsHostNameAlt
        //  (eg: 
        // {
        //   'BT':{'microsoftWebSitesHostNameBindingsHostName':'...', 'microsoftWebSitesHostNameBindingsHostNameAlt':'...'}, 
        //   'ST':{'microsoftWebSitesHostNameBindingsHostName':'...', 'microsoftWebSitesHostNameBindingsHostNameAlt':'...'}
        // }.
        // Note that a cert can contain muliple hostnames.
        // 
        // Also, you have to own the name and make a CNAME record of it or you will be get a deployment error or :
        // "A CNAME record pointing from foobarsite.com to foobar.azurewebsites.net was not found. 
        // Alternative record awverify.foobarsite.com to awverify.foobar.azurewebsites.net was not found either."
        // 
        // The alt record is optional. But if the primary hostname is for 'www.foobar.com', use alt for 'foobar.com' 
        "environmentOverrides" : {
            "type": "object",
            "defaultValue": {
                "--": {
                    "microsoftWebSitesHostNameBindingsHostName": "",
                    "microsoftWebSitesHostNameBindingsHostNameAlt": "",
                    "microsoftCacheRedisProvision": true,
                    "microsoftDocumentDBDatabaseAccountsProvision": true,
                    "microsoftSearchSearchServicesProvision": true
                }
            },
            "metadata": {
                "description": "Optional. A hash, of environmentId to microsoftWebSitesHostNameBindingsHostName and microsoftWebSitesHostNameBindingsHostNameAlt (eg: {'BT':{'microsoftWebSitesHostNameBindingsHostName':'...', 'microsoftWebSitesHostNameBindingsHostNameAlt':'...'}, {'ST':{'microsoftWebSitesHostNameBindingsHostName':'...', 'microsoftWebSitesHostNameBindingsHostNameAlt':'...'}, }."
            }
        },

        // -------------------------------------------------------
        // Parameters: TEMPLATES
        // -------------------------------------------------------
		// Required. The templates release version of the remote templates. eg: 0.0 (without any prefix 'v')
        "templatesRelease":{
			"defaultValue":"",
            "metadata": {
                "description": "Required. The templates release version of the remote templates. eg: 0.0 (without any prefix 'v')"
            },
            "type": "string"
        },
        // The http based base url from which to download referenced Assembly ARM Templates. 
        // In most cases will be an Url to a Storage Account Container Url to which 
        // newly downloaded Source Files (just the ARM Templates) are copied to
        "linkedAssembliesArmTemplateRootUrl": {
            "metadata": {
                "description": "Required. The http based base url from which to download referenced linked Assembly ARM Templates. In most cases will be an Url to a Storage Account Container Url to which newly downloaded Source Files (just the ARM Templates) are copied to."
            },
            "type": "string"
        },
        // Optional. The Single Access Signature (SAS) required to append to Assembly ARM Template 
        // Uris in order to get them out of a secured Storage Account Container.
        "linkedAssembliesArmTemplateRootSas": {
            "defaultValue": "",
            "metadata": {
                "description": "Optional. The Single Access Signature (SAS) required to append to linked Assembly ARM Template Uris in order to get them out of a secured Storage Account Container."
            },
            "type": "string"
        },
        // The http based base url from which to download referenced linked Resource ARM Templates. 
        // In most cases will be an Url to a Storage Account Container Url to which 
        // newly downloaded Source Files (just the ARM Templates) are copied to
        "linkedResourcesArmTemplateRootUrl": {
            "metadata": {
                "description": "Required. The http based base url from which to download referenced linked Resource ARM Templates. In most cases will be an Url to a Storage Account Container Url to which newly downloaded Source Files (just the ARM Templates) are copied to."
            },
            "type": "string"
        },
        // Optional. The Single Access Signature (SAS) required to append to linked Resource ARM Template 
        // Uris in order to get them out of a secured Storage Account Container.
        "linkedResourcesArmTemplateRootSas": {
            "defaultValue": "",
            "metadata": {
                "description": "Optional. The Single Access Signature (SAS) required to append to linked Resource ARM Template Uris in order to get them out of a secured Storage Account Container."
            },
            "type": "string"
        },
        "resourceAltLocation": {
            "defaultValue": "southeastasia",
            "allowedValues": [
                "southeastasia"
            ],
            "metadata": {
                "description": "Optional. The alt resource location, used for Databases, and any other resources that can't be location in the primary resourceLocation."
            },
            "type": "string"
        },
        // There should be absolutely no need to provide custom names for each resoource...
        // Prefer Convention over Convention. 
        // That said, you'll need some kind common template for the names of the resources.
        // For example:
        // MYORG-MYAPP-{ENVID}-{BRANCHID}-{RESOURCETYPE}
        // or better yet:
        // MYORG-MYAPP-{ENVID}-{BRANCHID}-{RT}
        // where {RT} is automatically replaced as needed with a token to represent the final
        // resource name. 
        // An example output might be:
        // MYORG-MYAPP-BT-US1023-SQL-SERVER
        // Limitations to think about:
        // KeyVault names: Length:[3-24], alphanumeric, with dashes, lowercase and uppercase allowed
        // Storage Account names: Length [3-24], alphanumeric, no dashes, lowercase only
        // Database name: length: [1-?], alphanumeric, dashes allowed
        // Database server: length: [1-63], alphanumeric, dashes, allowed, lowercase only
        // DocumentDb: length: [1-24-31], alphanumeric, no dashes, lowercase only
        // Resource Group: length [1-...], alphanumeric, dashes, lowercase and uppercase allowed
        // App Insights: length [1-...], alphanumeric, dashes, lowercase and uppercase
        // App Site: length [1-...], alphanumeric, dashes, lowercase and uppercase allowed
        // BASICALLY:
        // * Only practical solution to keep naming consistent is to work within the minimum constraint
        //   of all lowercase, no dashes, limited to 24 chars. 
        // * Maybe end sections with numbers to be dividers:
        //   * eg: 123456789012345678901234 <- length
        //   * eg: edu0moe0app0branch00resourcetype00
        "resourceNameTemplate": {
            "metadata": {
                "description": "Required. The default name template to use when developing the names of newly created Resources (eg: 'MYORG-MYAPP-{ENVID}-{BRANCHID}-{RESOURCETYPE}')'."
            },
            "minLength": 6,
            "maxLength": 50,
            "type": "string"
        },
        // -------------------------------------------------------
        // Parameters: COMMON
        // -------------------------------------------------------
        // Tags that are common to all resources.
        "commonResourceTags": {
            "defaultValue": {},
            "metadata": {
                "description": "Optional. An Complex Object (ie, JSON) containing a series of stringKey/stringValues that are added to the target resource as Tags."
            },
            "type": "object"
        },
        // -------------------------------------------------------
        // Parameters: SECURITY
        // -------------------------------------------------------
        "microsoftSqlServerConnectionStringType": {
            "allowedValues": [
                // Rely on database admin name/pwd
                // Rely on storage keys.
                // The deployment process saves DB Admin Name/Password to the Resource Group's KeyVault.
                // The deployment process saves Storage Keys to the Resource Group's KeyVault.
                "insecure",
                // Rely on Azure Role assignment to an OAuth Service Pricipal
                // note this still is highly insecure as it 
                // involves the web.config committing to source code the client id and secret
                // The deployment process saves Storage Keys to the Resource Group's KeyVault.
                "sp",
                // Rely on Azure Role assignment to an MSI generated Service Principal.
                // No secrets are committed to source code, but requires 
                // token being added to the SqlConnection
                // as well as calls to the KeyVault, 
                // from which Secrets can be obtained to access resources that
                // are not yet MSI capable.
                // Note -- still involves assignment of Roles to the MSI/SP.
                // The deployment process saves Storage Keys to the Resource Group's KeyVault.
                "msi"
            ],
            "defaultValue": "msi",
            "metadata": {
                "description": "Optional. An flag specifying if the vault is enabled for VM or Service Fabric deployment"
            },
            "type": "string"
        },
        // -------------------------------------------------------
        // Parameters: MICROSOFT / AUTHORISATION
        // -------------------------------------------------------
        // N / A
        // -------------------------------------------------------
        // Parameters: MICROSOFT / CACHE / REDIS
        // -------------------------------------------------------
        "microsoftCacheRedisProvision": {
            "defaultValue": true,
            "metadata": {
                "description": "Optional. Cache has a minimum cost of about 20$ per month. But, more importantly, it takes ages to provision."
            },
            "type": "bool"
        },
        // -------------------------------------------------------
        // Parameters: MICROSOFT / KEYVAULT / VAULTS
        // -------------------------------------------------------
        // N / A
        // -------------------------------------------------------
        // Parameters: MICROSOFT / KEYVAULT / VAULTS / SECRETS
        // -------------------------------------------------------
        "microsoftKeyVaultVaultsSecretsSecrets": {
            "type": "array",
            // A surprising fact is that the pre-parser that allows
            // JSON to be added to the ARM template -- even though
            // JSON does not support comments -- does not work within
            // Arrays. So Do NOT comment within the array!
            // **************************************************
            // it is *IMPERATIVE* that no comments are added *within* the 
            // dynamic array. 
            // Or you will get an error saying 
            // Invalid array passed in, ',' expected. (76956)
            // It's just that JSON does not allow Comments. And even though
            // the pre-parser strips out comments in between objects, it doesn't 
            // in this case.
            // I know...right?!?!? What's up with that??!?? Grrrrr!!!
            // **************************************************
            "defaultValue": [
                {
                    "name": "system-integration-scanii-malwaredetection-oauth-clientid",
                    "type": "text/plain",
                    "value": "todo:how to get this from vault?"
                },
                {
                    "name": "system-integration-scanii-malwaredetection-oauth-clientsecret",
                    "type": "text/plain",
                    "value": "todo:how to get this from vault?"
                }
            ],
            "metadata": {
                "description": "Optional. An array of Complex of name, type, value. With no comments allowed within the array (due to bug in VSTS)."
            }
        },//~keyvault
        // -------------------------------------------------------
        // Parameters: MICROSOFT / SQL / SERVERS
        // -------------------------------------------------------
        // Provide the Sql Server Administrator's name, which an 
        // infrastructure support specialist will have 
        // defined and set within a key vault 
        // outside of the projects resource group (and probably 
        // in a different subscription) so use the reference approach
        //  to get it out, and place it here.
        // Required when creating a new Database Server. 
        // Note that security is not perfect: a developer can develop
        // arm templates whose output records the values it extracts
        // from a keyvault.
        // "reference": {
        //   "keyVault": {
        //     "id": "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.KeyVault/vaults/{keyvaultName}"
        //   },
        //   "secretName": "{keyName}"
        // }
        "microsoftSqlServersAdministratorLogin": {
            "minLength": 6,
            "metadata": {
                "description": "Required. Provide the Sql Server Administrator's name, which an infrastructure support specialist will have defined and set within a key vault outside of the projects resource group (and probably in a different subscription) so use the reference approach to get it out, and place it here. Required when creating a new Database Server. Note that security is not perfect: a developer can develop arm templates whose output records the values it extracts from a keyvault. Provide the Sql Server Administrator's Login. Required when creating a new Database Server. This is unfortunate as it requires risk-mitigation processes around deployment to correctly secure the secret and not leave it in the hands of stakeholders that don't absolutely need to know it. Developers don't."
            },
            "type": "string"
        },
        // Provide the Sql Server Administrator's Password, which an 
        // infrastructure support specialist will have 
        // set the provided the password in a key vault 
        // outside of the projects resource group (and probably 
        // in a different subscription) so use the reference approach
        //  to get it out, and place it here.
        // Required when creating a new Database Server. 
        // Note that security is not perfect: a developer can develop
        // arm templates whose output records the values it extracts
        // from a keyvault.
        // "reference": {
        //   "keyVault": {
        //     "id": "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.KeyVault/vaults/{keyvaultName}"
        //   },
        //   "secretName": "{keyName}"
        // }
        "microsoftSqlServersAdministratorLoginPassword": {
            "metadata": {
                "description": "Required. Provide the Sql Server Administrator's Password, which an infrastructure support specialist will have defined and set within a key vault outside of the projects resource group (and probably in a different subscription) so use the reference approach to get it out, and place it here.  Required when creating a new Database Server.  Note that security is not perfect: a developer can develop arm templates whose output records the values it extracts from a keyvault."
            },
            "type": "securestring"
        },
        // The Name of the ARM developer (ie *you*!) who is certifying they 
        // understand the security risks of recording passwords in a parameter file, 
        // or any other code, and are not doing it here (and the code base's commit history
        //  will back them up). 
        // Instead, the value will be retrieved from an eternal keyvault to which the 
        // build service has been granted access. 
        "microsoftSqlServersDeveloperStatingSecretsAreNotRecordedInCode": {
            "minLength": 4,
            "metadata": {
                "description": "Required. The Name of the ARM developer (ie *you*!) who is certifying they understand the security risks of recording passwords in a parameter file, or any other code and are not doing it here (and the code base's commit history will back them up). Instead, the value will be retrieved from an eternal keyvault to which the build service has been granted access. "
            },
            "type": "string"
        },
        // -------------------------------------------------------
        // Parameters: MICROSOFT / WEB / CERTIFICATE
        // -------------------------------------------------------
        // Not needed, as must be same as parent Resource Location:
        // "microsoftWebCertificatesResourceLocation": 
        // 
        // In the parameter, retrieve the value from a remote keyvault (outside the target resource group)
        // using code similar to the following:  
        //   // Provide a password for this pfx
        //   "microsoftWebCertificatesPfxPassword": {
        //     "reference": {
        //       "keyVault": {
        //         "id": "/subscriptions/{subscriptionId}/resourceGroups/{group-name}/providers/Microsoft.KeyVault/vaults/{vault-name}"
        //       },
        //     "secretName": "{keyName}"
        //     }        
        //   },
        "microsoftWebCertificatesPfxBase64": {
            "defaultValue": "",
            "metadata": {
                "description": "Optional.   Base64 encoded PFX certificate for appService Web Site SSL. Required to match the information within appServiceWebSiteHostName."
            },
            "type": "string"
        },
        // In the parameter, retrieve the value from a remote keyvault (outside the target resource group)
        // using code similar to the following:  
        //   // Provide a password for this pfx
        //   "microsoftWebCertificatesPfxPassword": {
        //     "reference": {
        //       "keyVault": {
        //         "id": "/subscriptions/{subscriptionId}/resourceGroups/{group-name}/providers/Microsoft.KeyVault/vaults/{vault-name}"
        //       },
        //       "secretName": "{keyName}"
        //     }        
        //   },
        "microsoftWebCertificatesPfxPassword": {
            "metadata": {
                "description": "Optional.   Password for the appService Web Site SSL Pfx Certificate. Only required if `sslCertificateBase64` is provided."
            },
            "type": "securestring"
        },
        // The Name of the ARM developer (ie *you*!) who is certifying they 
        // understand the security risks of recording passwords in a parameter file, 
        // or any other code, and are *NOT* doing it here (and the code base's commit history
        //  will back them up). 
        // Instead, the value will be retrieved from an eternal keyvault to which the 
        // build service has been granted access. 
        "microsoftWebCertificatesDeveloperStatingSecretsAreNotRecordedInCode": {
            "minLength": 4,
            "metadata": {
                "description": "The Name of the ARM developer (ie *you*!) who is certifying they understand the security risks of recording passwords in a parameter file, or any other code and are not doing it here (and the code base's commit history will back them up). Instead, the value will be retrieved from an eternal keyvault to which the build service has been granted access. "
            },
            "type": "string"
        },
        // -------------------------------------------------------
        // Parameters: MICROSOFT / WEB / SERVERFARMS
        // -------------------------------------------------------
        // B1 (Basic Small) or higher is needed for HostBinding and SSL.
        // B1 is about 95$/month, and S1 is about 135/month.
        // And S1 gets backups every day. 
        // At 1$/day more, it's worth the it, for a corporation.
        "microsoftWebServerFarmsResourceSku": {
            "allowedValues": [
                "F1",
                "D1",
                "B1",
                "S1",
                "S2"
            ],
            "defaultValue": "F1",
            "metadata": {
                "description": "Optional. App Service server pricing tier and capacity. Check details at https://azure.microsoft.com/en-us/pricing/details/app-service/ Default is F1 to keep prices down until you know you need Site Binding. Or AlwaysOn. Or other features that need a mininum of S1."
            },
            "type": "string"
        },
        // -------------------------------------------------------
        // Parameters: MICROSOFT / WEB / SITE 
        // -------------------------------------------------------
        // Optional. The default is false as true requires a minimal SKU of S1.
        "microsoftWebSitesAlwaysOn": {
            "defaultValue": false,
            "metadata": {
                "description": "Optional. The default is false as true requires a minimal SKU of S1."
            },
            "type": "bool"
        },
        // -------------------------------------------------------
        // Parameters: MICROSOFT / WEB / SITE / APPSETTINGS
        // -------------------------------------------------------
        // Optional. A Complex Object (ie, JSON) containing a series 
        // of stringKey/stringValues that are added to the target site as AppSettings.
        // An example would be:
        //     "defaultValue": {
        //         "ExampleKey": "exampleValue"
        //     },
        "microsoftWebSitesConfigAppSettings": {
            "defaultValue": {},
            "metadata": {
                "description": "Optional. A Complex Object (ie, JSON) containing a series of stringKey/stringValues that are added to the target site as AppSettings."
            },
            "type": "object"
        },
        // The Name of the ARM developer (ie *you*!) who is certifying they 
        // understand the security risks of recording passwords in a parameter file, 
        // or any other code, and are not doing it here (and the code base's commit history
        //  will back them up). 
        "microsoftWebSitesConfigAppSettingsDeveloperStatingSecretsAreNotRecordedInCode": {
            "minLength": 4,
            "metadata": {
                "description": "The Name of the ARM developer (ie *you*!) who is certifying they understand the security risks of recording passwords in a parameter file, or any other code and are not doing it here (and the code base's commit history will back them up)."
            },
            "type": "string"
        },
        // -------------------------------------------------------
        // Parameters: MICROSOFT / WEB / SITE / CONNECTIONSTRINGS
        // -------------------------------------------------------
        // "Optional. A Complex Object (not an array) of a set of {'name' { 'value' and 'type'}}, that are added to the site's ConnectionStrings. Type should be 2 in most cases."
        // Type is case sensitive string, and can be MySql, SQLServer, SQLAzure, Custom, NotificationHub, ServiceBus, EventHub, ApiHub, DocDb, RedisCache, PostgreSQL. SQL 
        // If things stop working, ensure:
        // it's an object of complex object of name:key/values.
        // If things stop working, tips to find the reason include:
        // ensure you are passing an object {} and not an array
        // ensure the name is the key to a sub object of two params, and not an array of objects containing 3 objects
        // ensure the type is string, and case sensitive (and not a number)
        // An example might be:
        // "defaultValue": {
        //     "ExampleConnString1": {
        //         "value": "Server=myServerAddress;Database=myDataBase;Trusted_Connection=True;",
        //         "type": "SQLAzure"
        //     },
        //     "ExampleConnString2": {
        //         "value": "Server=myServerAddress;Database=myDataBase;Trusted_Connection=True;",
        //         "type": "SQLAzure"
        //     },
        //     "defaultSystemConnectionString": {
        //         "value": "Data Source={DB_SERVER}.database.windows.net,1433;Initial Catalog={DB_NAME};Connect Timeout={DB_TIMEOUT};",
        //         "type": "SQLAzure"
        //     }
        // },
        "microsoftWebSitesConfigConnectionStrings": {
            "defaultValue": {},
            "metadata": {
                "description": "Optional. A Complex Object (not an array) of a set of {'name' { 'value' and 'type'}}, that are added to the site's ConnectionStrings. Type is Case Senstive. And probably should be SQLAzure in most cases."
            },
            "type": "object"
        },
        // The Name of the ARM developer (ie *you*!) who is certifying they 
        // understand the security risks of recording passwords in a parameter file, 
        // or any other code, and are not doing it here (and the code base's commit history
        //  will back them up). 
        // Instead, use the Azure equivalent to IntegratedSecurity (ie, MSI).
        "microsoftWebSitesConfigConnectionStringsDeveloperStatingSecretsAreNotRecordedInCode": {
            "minLength": 4,
            "metadata": {
                "description": "The Name of the ARM developer (ie *you*!) who is certifying they understand the security risks of recording passwords in a parameter file, or any other code and are not doing it here (and the code base's commit history will back them up). Instead, use the Azure equivalent to IntegratedSecurity (ie, MSI)."
            },
            "type": "string"
        },
        // -------------------------------------------------------
        // Parameters: MICRSOOFT / WEB / SITE / HOSTBINDINGNAME
        // -------------------------------------------------------
        "microsoftWebSitesHostNameBindingsHostName": {
            "type": "string",
            "minLength": 0,
            "metadata": {
                "description": "Required. The public DNS name of the website. Default is ''. Will require a WebServerFarm SKU of S1 of higher to be set."
            }
        },
        // Optional. If 'microsoftWebSitesHostNameBindingsHostName' is used 
        // for 'www.mydomain.tld', you want to be able to 
        // also register 'mydomain.tld' as well.
        "microsoftWebSitesHostNameBindingsHostNameAlt": {
            "type": "string",
            "minLength": 0,
            "defaultValue": "",
            "metadata": {
                "description": "Optional. If 'microsoftWebSitesHostNameBindingsHostName' is used for 'www.mydomain.tld', you want to be able to also register 'mydomain.tld' as well."
            }
        },

        // -------------------------------------------------------
        // Parameters: SERVICES / OAUTHSERVICE / CLIENT / BASICS
        // -------------------------------------------------------
        // Optional.
        // Hook up to an OAuth Authority (you will need 
        // to provide the OAuth AuthorityUri, ClientId ClientKey.
        "servicesOAuthServiceEnabled": {
            "type": "bool",
            "defaultValue": true,
            "metadata": {
                "description": "Hook up to an OAuth Authority (you will need to provide the OAuth AuthorityUri, ClientId ClientKey."
            }
        },
        // Optional. If your system needs to authenticate users, it should be via OIDC. 
        // Which is an extension of OAuth. 
        // If authenticating systems, it should be via OAuth.  
        // Both require that you have the ClientId and ClientSecret that were developed 
        // by the remote IdP when you registered your app with it.
        "servicesOAuthServiceClientId": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Optional. If your system needs to authenticate users, it should be via OIDC. Which is an extension of OAuth. If authenticating systems, it should be via OAuth.  Both require that you have the ClientId and ClientSecret that were developed by the remote IdP when you registered your app with it."
            }
        },
        // Optional. If your system needs to authenticate users, it should be via OIDC. 
        // Which is an extension of OAuth. 
        // If authenticating systems, it should be via OAuth.  
        // Both require that you have the ClientId and ClientSecret that were developed 
        // by the remote IdP when you registered your app with it.
        "servicesOAuthServiceClientSecret": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Optional. If your system needs to authenticate users, it should be via OIDC. Which is an extension of OAuth. If authenticating systems, it should be via OAuth. Both require that you have the ClientId and ClientSecret that were developed by the remote IdP when you registered your app with it."
            }
        },
        // Optional. Where the system sends authentication requests off to.
        "servicesOAuthServiceAuthorityUri": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Optional. Where the system sends authentication requests off to."
            }
        },
        // Optional. If your system needs to authenticate users, using OIDC, 
        // you have to redirect Users back from the remote IDP to this system's Homepage.
        // This is the 'redirect_uri' value of an OAuth request.
        //  '/' won't work (that would be the IdP's home page). 
        // If not provided, will be automatically generated using 'https' and your host binding name you provided.
        "servicesOAuthServiceClientRedirectUri": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Optional. If your system needs to authenticate users, using OIDC, you have to redirect Users back from the remote IDP to this system's Homepage. This is the 'redirect_uri' value of an OAuth request. '/' won't work (that would be the IdP's home page). If not provided, will be automatically generated using 'https' and your host binding name you provided."
            }
        },
        // Optional. If your system needs to authenticate users, using OIDC, 
        // after a user is signed off (destroying their security token), 
        // you want to redirect them to the home page or other. The default is '/'.
        // It's not part of the protocol - it's just a value to that code 
        // wrapping the prootocol can use.
        "servicesOAuthServiceClientPostLogoutRedirectUri": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Optional. If your system needs to authenticate users, using OIDC, after a user is signed off (destroying their security token), you want to redirect them to the home page or other. The default is '/'."
            }
        },
        // -------------------------------------------------------
        // Parameters: SERVICES / OIDCSERVICE / SERVER
        // -------------------------------------------------------
        // TBD
        // -------------------------------------------------------
        // Parameters: SERVICES / OIDCSERVICE / POLICIES 
        // (ONLY RELEVANT WITH A POLICY BASED OIDC IDP, SUCH AS AZURE B2C)
        // -------------------------------------------------------
        "servicesOIDCServicePoliciesSignUpSignInPolicyId": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Optional. The name of the B2C's Policy/Flow to use for SignUp/SignIn."
            }
        },
        "servicesOIDCServicePoliciesUserProfilePolicyId": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Optional. The name of the B2C's Policy/Flow to use for retrieving the User Profile."
            }
        },
        "servicesOIDCServicePoliciesEditProfilePolicyId": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Optional. The name of the B2C's Policy/Flow to use for editing the User Profile."
            }
        },
        "servicesOIDCServicePoliciesResetPasswordPolicyId": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Optional. The name of the B2C's Policy/Flow to use for reseting the user's Password."
            }
        }


    },
    "variables": {
        // -------------------------------------------------------
        // VARIABLES: RESOURCES
        // -------------------------------------------------------
        "environmentId": "[parameters('environmentId')]",
        "environmentOverrides": "[parameters('environmentOverrides')]",
       // -------------------------------------------------------
        // VARIABLES: RESOURCES
        // -------------------------------------------------------
        "microsoftSqlServerConnectionStringType": "[parameters('microsoftSqlServerConnectionStringType')]",
        // -------------------------------------------------------
        // VARIABLES: RESOURCES
        // -------------------------------------------------------
        "resources": {
            "resourceNamePrefix": "[toLower('arm.start')]",
            "resourceNameTemplate": "[parameters('resourceNameTemplate')]",
            "commonResourceTags": "[parameters('commonResourceTags')]"
        },
        // -------------------------------------------------------
        // VARIABLES: LOCATIONS
        // -------------------------------------------------------
        "locations": {
            // Nearshore, closest:
            "resourceLocation": "[resourceGroup().location]",
            // When a resource cannot be developed in the primary data center, fall back to secondary Nearshore:
            "resourceAltLocation": "[parameters('resourceAltLocation')]"
        },
        // -------------------------------------------------------
        // VARIABLES: ASSEMBLY
        // -------------------------------------------------------
        "assembly": {
            "armTemplateId": "[concat(variables('resources').resourceNamePrefix, 'assembly.01')]",
            "linkedAssembly01TemplateUrl": "[concat( replace( parameters('linkedAssembliesArmTemplateRootUrl'),'{TEMPLATESRELEASE}', parameters('templatesRelease')), 'arm.assembly.01.json', parameters('linkedAssembliesArmTemplateRootSas'))]",
            "linkedResourcesArmTemplateRootUrl": "[replace( parameters('linkedResourcesArmTemplateRootUrl'),'{TEMPLATESRELEASE}', parameters('templatesRelease'))]",
            "linkedResourcesArmTemplateRootSas": "[parameters('linkedResourcesArmTemplateRootSas')]"
        }
        // -------------------------------------------------------
    }, //~variables
    // ----------------------------------------------------------------------
    // ----------------------------------------------------------------------
    // Resources
    // ----------------------------------------------------------------------
    // ----------------------------------------------------------------------
    "resources": [
        // -------------------------------------------------------
        // RESOURCES: COMMON `ASSEMBLIES` LINKED TEMPLATE
        // -------------------------------------------------------
        {
            "name": "[variables('assembly').armTemplateId]",
            "apiVersion": "2017-05-10",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('assembly').linkedAssembly01TemplateUrl]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    // -------------------------------------------------------
                    // Pass through the above parameters to the parameters
                    // of the linked Assemblies ARM Template. 
                    // We could do any one of them...but the whole idea
                    // is to rely as much as possible on the default values
                    // of the linked ARM template, in order to keep this 
                    // project specific ARM template as light/simple/maintainable
                    // as possible.
                    // -------------------------------------------------------
                    "environmentId": {
                        "value": "[variables('environmentId')]"
                    },
                    "environmentOverrides": {
                        "value": "[variables('environmentOverrides')]"
                    },
                    // -------------------------------------------------------
                    "linkedResourcesArmTemplateRootUrl": {
                        "value": "[variables('assembly').linkedResourcesArmTemplateRootUrl]"
                    },
                    "linkedResourcesArmTemplateRootSas": {
                        "value": "[variables('assembly').linkedResourcesArmTemplateRootSas]"
                    },
                    "resourceAltLocation": {
                        "value": "[variables('locations').resourceAltLocation]"
                    },
                    "resourceNameTemplate": {
                        "value": "[variables('resources').resourceNameTemplate]"
                    },
                    "commonResourceTags": {
                        "value": "[variables('resources').commonResourceTags]"
                    },
                    "microsoftSqlServerConnectionStringType": {
                        "value": "[variables('microsoftSqlServerConnectionStringType')]"
                    },
                    // -------------------------------------------------------
                    // Passthrough Parameters: MICROSOFT / AUTHORISATIONS 
                    // -------------------------------------------------------
                    // TODO
                    // -------------------------------------------------------
                    // Passthrough Parameters: MICROSOFT / CACHE / REDIS 
                    "microsoftCacheRedisProvision":{
                        "value": "[parameters('microsoftCacheRedisProvision')]"
                    },
                    // -------------------------------------------------------
                    // Passthrough Parameters: MICROSOFT / SQL / SERVERS  
                    "microsoftSqlServersAdministratorLogin": {
                        "value": "[parameters('microsoftSqlServersAdministratorLogin')]"
                    },
                    "microsoftSqlServersAdministratorLoginPassword": {
                        "value": "[parameters('microsoftSqlServersAdministratorLoginPassword')]"
                    },
                    "microsoftSqlServersDeveloperStatingSecretsAreNotRecordedInCode": {
                        "value": "[parameters('microsoftSqlServersDeveloperStatingSecretsAreNotRecordedInCode')]"
                    },
                    // -------------------------------------------------------
                    // Passthrough Parameters: MICROSOFT / SQL / DATABASES
                    // TBD  
                    // -------------------------------------------------------
                    // Passthrough Parameters: MICROSOFT / WEB / SERVERFARMS
                    "microsoftWebServerFarmsResourceSku": {
                        "value": "[parameters('microsoftWebServerFarmsResourceSku')]"
                    },
                    // -------------------------------------------------------
                    // Passthrough Parameters: MICROSOFT / WEB / CERTIFICATE 
                    "microsoftWebCertificatesPfxBase64": {
                        "value": "[parameters('microsoftWebCertificatesPfxBase64')]"
                    },
                    "microsoftWebCertificatesPfxPassword": {
                        "value": "[parameters('microsoftWebCertificatesPfxPassword')]"
                    },
                    "microsoftWebCertificatesDeveloperStatingSecretsAreNotRecordedInCode": {
                        "value": "[parameters('microsoftWebCertificatesDeveloperStatingSecretsAreNotRecordedInCode')]"
                    },
                    // -------------------------------------------------------
                    // Passthrough Parameters: MICROSOFT / WEB / SITES 
                    "microsoftWebSitesAlwaysOn": {
                        "value": "[parameters('microsoftWebSitesAlwaysOn')]"
                    },
                    // -------------------------------------------------------
                    // Passthrough Parameters: MICROSOFT / WEB / SITES / CONFIG / APPSETTINGS
                    "microsoftWebSitesConfigAppSettings": {
                        "value": "[parameters('microsoftWebSitesConfigAppSettings')]"
                    },
                    "microsoftWebSitesConfigAppSettingsDeveloperStatingSecretsAreNotRecordedInCode": {
                        "value": "[parameters('microsoftWebSitesConfigAppSettingsDeveloperStatingSecretsAreNotRecordedInCode')]"
                    },
                    // -------------------------------------------------------
                    // Passthrough Parameters: MICROSOFT / WEB / SITES / CONFIG / CONNECTIONSTRINGS
                    "microsoftWebSitesConfigConnectionStrings": {
                        "value": "[parameters('microsoftWebSitesConfigConnectionStrings')]"
                    },
                    "microsoftWebSitesConfigConnectionStringsDeveloperStatingSecretsAreNotRecordedInCode": {
                        "value": "[parameters('microsoftWebSitesConfigConnectionStringsDeveloperStatingSecretsAreNotRecordedInCode')]"
                    },
                    // -------------------------------------------------------
                    // Passthrough Parameters: MICROSOFT / WEB / SITES / HOSTNAMEBINDINGS
                    "microsoftWebSitesHostNameBindingsHostName": {
                        "value": "[parameters('microsoftWebSitesHostNameBindingsHostName')]"
                    },
                    "microsoftWebSitesHostNameBindingsHostNameAlt": {
                        "value": "[parameters('microsoftWebSitesHostNameBindingsHostNameAlt')]"
                    },
                    // -------------------------------------------------------
                    // Passthrough Parameters: SERVICES / OAUTHSERVICE / Client
                    "servicesOAuthServiceEnabled": {
                        "value": "[parameters('servicesOAuthServiceEnabled')]"
                    },
                    "servicesOAuthServiceAuthorityUri": {
                        "value": "[parameters('servicesOAuthServiceAuthorityUri')]"
                    },
                    "servicesOAuthServiceClientId": {
                        "value": "[parameters('servicesOAuthServiceClientId')]"
                    },
                    "servicesOAuthServiceClientSecret": {
                        "value": "[parameters('servicesOAuthServiceClientSecret')]"
                    },
                    "servicesOAuthServiceClientRedirectUri": {
                        "value": "[parameters('servicesOAuthServiceClientRedirectUri')]"
                    },
                    "servicesOAuthServiceClientPostLogoutRedirectUri": {
                        "value": "[parameters('servicesOAuthServiceClientPostLogoutRedirectUri')]"
                    },
                    // -------------------------------------------------------
                    // Passthrough Parameters: SERVICES / OIDCSERVICE / Server
                    // TBD
                    // -------------------------------------------------------
                    // Passthrough Parameters: Oidc / Policies
                    "servicesOIDCServicePoliciesSignUpSignInPolicyId": {
                        "value": "[parameters('servicesOIDCServicePoliciesSignUpSignInPolicyId')]"
                    },
                    "servicesOIDCServicePoliciesUserProfilePolicyId": {
                        "value": "[parameters('servicesOIDCServicePoliciesUserProfilePolicyId')]"
                    },
                    "servicesOIDCServicePoliciesEditProfilePolicyId": {
                        "value": "[parameters('servicesOIDCServicePoliciesEditProfilePolicyId')]"
                    },
                    "servicesOIDCServicePoliciesResetPasswordPolicyId": {
                        "value": "[parameters('servicesOIDCServicePoliciesResetPasswordPolicyId')]"
                    },
                    // -------------------------------------------------------
                } //~parameters
            } //~properties
         } //~assemblies linked template
    ],
    // -------------------------------------------------------
    // OUTPUTS
    // -------------------------------------------------------
    "outputs": {
        // The Azure AD Tenant Id (in which the identityId is a member).
        "tenantId":{
            "type":"string",
            "value": "[reference(variables('assembly').armTemplateId).outputs.tenantId.value]"
        },
        // Get's the Id of the WebSite's service account.
        "principalId": {
            "type": "string",
            "value": "[reference(variables('assembly').armTemplateId).outputs.principalId.value]"
        },
        // The current Azure compute subscription Id (within which the resources were created)
        "subscriptionId":{
            "type":"string",
            "value": "[reference(variables('assembly').armTemplateId).outputs.subscriptionId.value]"
        },
        // The name  of the Keyvault resource, which can be of use when applying rights using Powershell:
        // May be required for scripting permissions (although probably won't - we've given principalId access to the whole resource group)
        "defaultKeyVaultResourceName": {
            "type": "string",
            "value": "[reference(variables('assembly').armTemplateId).outputs.defaultKeyVaultResourceName.value]"
        },
        // The name of the apps sql server on which one or more databases are created
        // May be required for scripting permissions (although probably won't - we've given principalId access to the whole resource group)
        "defaultSqlServerResourceName": {
            "type": "string",
            "value": "[reference(variables('assembly').armTemplateId).outputs.defaultSqlServerResourceName.value]"
        },
        // The name of the primary default database (usually the only one). Requires backing up (see 'defaultStorageAccountResourceName').
        // May be required for scripting permissions (although probably won't - we've given principalId access to the whole resource group)
        "defaultSqlServerDefaultDatabaseResourceName": {
            "type": "string",
            "value": "[reference(variables('assembly').armTemplateId).outputs.defaultSqlServerDefaultDatabaseResourceName.value]"
        },
        // The name of one of the non-required storage accounts (can be deleted if need be)
        // May be required for scripting permissions (although probably won't - we've given principalId access to the whole resource group)
        "diagnosticsStorageAccountResourceName": {
            "type": "string",
            "value": "[reference(variables('assembly').armTemplateId).outputs.diagnosticsStorageAccountResourceName.value]"
        },
        // The name of one of the non-required storage accounts (can be deleted if need be)
        // May be required for scripting permissions (although probably won't - we've given principalId access to the whole resource group)
        "tempStorageAccountResourceName": {
            "type": "string",
            "value": "[reference(variables('assembly').armTemplateId).outputs.tempStorageAccountResourceName.value]"
        },
        // The name of the default required storage accounts. Requires backing up (see 'microsoftSqlServersDatabasesResourceName')
        // May be required for scripting permissions (although probably won't - we've given principalId access to the whole resource group)
        "defaultStorageAccountResourceName": {
            "type": "string",
            "value": "[reference(variables('assembly').armTemplateId).outputs.defaultStorageAccountResourceName.value]"
        },
        // Name of the WebSite that uses sqlserver, storage, keyvault, etc.
        "defaultWebSiteResourceName": {
            "type": "string",
            "value": "[reference(variables('assembly').armTemplateId).outputs.defaultWebSiteResourceName.value]"
        },
        // I'm not keen on this output, as it's inherently insecure (if using the 'insecure' flag). But for now...let's wait and see
        // if it essential.
        "defaultWebSitesDefaultConnectionString": {
            "type": "string",
            "value": "[reference(variables('assembly').armTemplateId).outputs.defaultWebSiteDefaultConnectionString.value]"
        }
    } //~output

}